{"hash":"5c016b27a73a79e88fa4c47a961625675662d228","data":{"post":{"title":"Implementación de Bluetooth GATT Server en Android","date":"July 6, 2023","content":"<p>En este artículo iremos directamente a la implementación de un <em>GATT server</em> para una estación meteorológica. Como recordatorio de cómo vamos a estructurar nuestra estación meteorológica podemos observar la siguiente imagen.</p>\n<p><img class=\"g-image g-image--lazy g-image--loading\" src=\"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 953 770' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-99a702632ca4c444db43d1699085a1ed'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-99a702632ca4c444db43d1699085a1ed)' width='953' height='770' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAA0CAYAAAA62j4JAAAACXBIWXMAAAsSAAALEgHS3X78AAAMQklEQVRo3u1bR3Nb1xVWSXbOZJes8w%2byTdbJJpOZ/IRMJll4kTJ2LC%2biOFGSkT2KrcpOkCIplvdIiqDQCRAkARAdeOh4D40gWMAukbJsq1Dkl3Mv3gNBWbKjWJSFmWDmm3PLu%2b2759zGw1OnXuJnVcRTFkXgYZJn1bS3KPwHiyxMWxWhRFi0ykKZsHgMirhI3yzacqOLU/nRRXthnDDGwyxNg/adWs8zddTlAn3nJvyFvv0B748snDnqp3DqRH4WIkBt4KxKwk%2boEwueqgkzlUnYi%2bNfCQfBnB2BMTWECakf%2btgAjOkhnmbOjHA5VRj72noYZhb1YO1SH7apX79S%2b3emRob46gdPzGvyjErCj6nxR2zgFH5MeEoNH5B8LizZkYPp0u2D62MXD969%2bPbBBy3vHlwV/3Vw/vo7B3%2b98c7BhY5zBxfazx2YM8MHNoXqkYUX11Vr5ymR/8RRug0G6ssvVRI0zTw5DVDDwbnlOzR4kQYvgjp1SJ06ZNIgi3ghsiLuZASYcmMw58d5eDIt1CTBII/iq8qbCVo7rF0KP5kuT7B%2brBC%2bV5sk8bTlVRPANMCqqhjJnzEVpLSnR50RDo3UuSlFQLQ4CGVhALmF/jryBKXUiD7IxT6ep6XVwn3HyjUiVryF6RyZkEpCDRSWxSeuFQPTgt81rk%2bvfPZpoVFtX7zAGqQO7Ftqs8AHHywM4fMVHVDt/DJWO4AtyrvbC9y7Cez0ALskN7traQws7R7J9S4q0/Hceh6tdCNORBiPaYKw764aiQCxX52ss69eA6hC65F9tXHGZXGfdcJEnfHmh3C42sU7eUCShQ84uvF0hdI3ehG2nsfs%2bHsIWc7DrX8f0akPUPR9CNfEOaTn/oHE9N8h2f%2bGB8VWYE3Hy9ZwVJ9GBNOyBhL255aZBogGlYATMgFVA0i2aRpA4Ha5s9RTHzyTNTLaaSA3aPav0%2by3YcH3AaLWP8Mz8Xv4DX%2bCd/KPWA5fgI9kavp9JOznePqj8mXSghYqf6NWvtp2jFwmHyzrYKO2NQ3gBMgqAQoRIL8GDWANs8HPkl0%2bbRh4rbNteLQ0gvuLM7hfnsHuwjS%2bWJnD4zU3nqx7uGT4fHmO4vN4VHXjYdWFx5T3aWUWe2UnL7u74MQXlTFOpla3RoafTE7VgtegAY0ENGhATf2H653SBv9g8Q4KqU1EAyuIhdaQjGwiGd2k8DqkYBVxkonIJs8L%2b5Z5OBHZ4HkxhlCVwqtIUZlccpuIsNc1QdOCCJkB2xlszxKgfGsEdNVVv5LNoph9AL1ow0f/vIqO6/24/FErl5982IKWyzrc0o1DHDDi44staL92E61XetB29Sblt6KnfRif0PfWSRfVs4dSukwD1x0zA40A6xtFgKoFi9kCzdwOlMQaosEFRAIlBH15ZCieitPMxlaQJpmOV5GILiEeWaK01Vo%2b5cXCi5BCZaSlZeRTWyiml2kxvcl3hyYhIE8mcA/%2bQAGuzAq88ho6R4y40iPgcvcwrvaKPNwycBujjgDEKR8utQ9QfALdohn%2b/Ca8uXXM%2b3LIkwnUCOhtLgLyRECEZtFF8NIsW51J3LGGoTcHYbJLMNgisM4kYXdlYHEmePq4wcvzgokqPJEKQqQ9%2bdR2c2pALrWLbFRBITaPbHgexWQQ5XQEC6kw8jE/CvEASskQiokAFMmHHKVVshJykh9RzzR9G0A6kuWm1HQEVIgAObmHQjKJ/V03fM4ezJrb4DDcwIy5FS5bB%2bYsbfA7dUTEOOas7XARWLycnqQ8OkM8CCAXlyAndmgRbEINyKfvIR4sYI7s2zMd4pi1%2beB1hjnmKe52BBF0xWr5jto3vtkIz3fT2iD5WT07TWoC6V0kfTKqZAYxuxfjXYPQ9wzDPnKHS%2bvgBIehT0TU5uFh25AeDsEAaWoeG/Ei4p40mdJ28xKQoFVc8SQRmw7DTmcC06ABNsHC5ZRohXXEDMuwCe47c3CMTtXzQjZaI3xZxObl5iWA7QLxSBHeYAT%2bUAyhaBLRWBoRKYWwlEQokuDhCKWxeCAcR5i%2bYd96fGEEo3FIYVbPTnNug4XUHg0yjkDRiWEznfQGL6Nj5BrJK%2bib7ET78FV0CtfpDDCAQVMPusQb6NN3wOAZxaj9FpJrAfgCtGM01S6gHoWX5CyU5C7SsTIkSYYUkREOpeH1SLS3pxANZxEJZ3iaRFtdOJjm8Ugog2Qij3gsh5ikICUt0DZ4FwuZMtX9xh%2bFjy5Dny3qSXXXqfO7JPcI91FI30cx8ymXhZQKCmt5WlqOts%2b8CnaWUJJb2FuwvfAy9MYRoJHweHmId3z3GKzPxL8eD5eEY9fhJtCAxgeRVpLfALx8w1tAc5iApgndz38ffEk0PoI0gQZoJHTwmTtY7cX%2bsu75WOl5cR7hKeVrW5%2bmBU2yCHbwLWstJ9EZfgkrhU1US9tcrha3OJbzG1ii624tvlmX1dJW7XuKV5QqbX9UXknhyfJgnYQ3nwCy2/V8CNkEreipLQz1m3Cz6zaEW1Z0tQpovTqAcWEa%2btFZ6NpHIQ7ZMNRnwmCfEb1d4xi8aYCuYxSz9jgKmR1k4ntEQpoT%2b4YT0MVNgHWOvQgpyW3a1jYwbQpgUnDAbvTBMOaEddLD4Z1JwTzhglXvgXF8hn9nHJ%2bFw%2bjHpOhAYDaNUmabtsUN0oSV5nwRioRKCCRXEFO2YJuNE2KwOCUY7SEOFnaHCpiPlGByhOGcz8BBF6B4bgvB1CqCgULzPogwAgJEgCu9Cg%2bhiy46V3Sj%2bKRrBC39elztHUMnXYbEqQAGjW5caruFy90iT/MTAV5lA152HU5uNeuL0D0kw2X4XAkE59P8WJtNVMimy/yInIotcMTpwiMFFcjJChJ0eZKCOQQ8KUIS8VCTPomxFyGFHWXjCTzZcePhphfBmV5E3QOIe4dgn7yB8FwfSgk9Iq4BBJw3kfIPIxMU4HPoqIwfh3t%2byJIEpRlfhGoE7EKO5VHJhWmLS8I3OwWnxYB5pxWzNiPcDjPSkXmezuIsPR5wIRX2YG0hheWChAxdiJryTbD%2bJOYvIOxMYN4axvSkGy6TH/6pKFxmP6WFKB6AxxJEdDbFpdtMV2BbBF5blKfFvKyeZlwEM%2bxFaI8/aS0HEgibnOi73IKef1%2bD0KJDz6VrGL7RRehE/5VWOIVJCK06yuvG0PVO%2bPQ2rEeziM4laC3Zad4XoSQtYv65OMKeDBLBPEcsoCARojt/IAfJJyPmV3gaQ9SbRZi2wpA7haCLFsFg6Q1ZBOVGAsT/goAcfxGKRFMIFeeRrSagd45hzCZAPz2GIcMAbun7YHJPwuo1YvBOPyYo3eozwUZIrcQQWwwhGIp/7YuQ7fX8dVho%2bPP4cQ2Y/9KLUKd6DthFNJKBP%2blFokAHoBkzBL2A26ZxjEyMcDlp08PsNGF4fAh6qx4zPiec3mlIcgSRbBChYLJBA46/CYaf1YBvyT/g0KEI3HWldhfo5neBrYKX9vv7tT%2bQxu/SbrCDAq0JpeynKGbu1yVLq6fz16HaC5Icr5Vj5TN0p6jmYkc3QvU%2b4CbiTY0OEiepAYzRuo%2bQLF5zLdc9RLh/ULncRwPv4I4ShyoRjIQKmUJFVgg50grlCBnlufGKBjlXA5VnFytN/bkjBrWzXullg9ecpfZrTlLixMkRQCZAA9ccJN92rxpVH6GaixzzDrvL3GTWGpyb%2bGsOm7FuPmsvD7Ucr6ejVhfV/9mKDjO5EeaawwbP2n/CnSZl8WO1f9%2bxyifiJyicVuWPCF/YcqNQnRZ5ZxgJxXI/PidzYDO1v1qT3xRaPQ%2bp3spiH3eVMx0NnrnKPXWUxpmb3E9VEz3z6gcva26y9Z3gom/Tyr1EKU/zF2SLEiPikPkNzb1CsPrsNGAyt8MGZ0lG/iPvhoUNXjhykhROncAiKKgLodCYNsYaZz7AKgn73HeQTIM6yXaIuvymYPWobnn1NphfMR%2b8LHgJb6lO06dPndTPIgvHTEHViPcIq85FPdi68LowuzTJSN%2bmti%2bR/O4xP2b5pLzF5SMNsDaSIIvfp1X359SZX1P4tyRPBkd1/4Ym4xfUnx82TITmxF136T8xEhr%2bZ%2bBk/HJf7nxy9siNX6xr6ck2yr1Gj4hgCw/hLNsmGSEW7qv7iiEfl2p7p%2buzzrQzO/L6Z0Bj31I7KWp3hpNBQ9319YikKWo69f/f//j7D8zC/oeVxj2cAAAAAElFTkSuQmCC' /%3e%3c/svg%3e\" width=\"953\" alt=\"Estructura GATT Server\" data-srcset=\"/assets/static/GATT-server-design.82a2fbd.9212b557fb93bfb6e5efcf787894c2aa.png 480w, /assets/static/GATT-server-design.d16fff3.9212b557fb93bfb6e5efcf787894c2aa.png 953w\" data-sizes=\"(max-width: 953px) 100vw, 953px\" data-src=\"/assets/static/GATT-server-design.d16fff3.9212b557fb93bfb6e5efcf787894c2aa.png\"><noscript><img class=\"g-image g-image--lazy g-image--loaded\" src=\"/assets/static/GATT-server-design.d16fff3.9212b557fb93bfb6e5efcf787894c2aa.png\" width=\"953\" alt=\"Estructura GATT Server\"></noscript></p>\n<p>Si quieres saber más acerca del funcionamiento general de BLE y GATT puedes visitar el artículo anterior donde abarcamos en detalle y de forma teórica el mismo: <a href=\"https://ivansantosgonzalez.dev/bluetooth-gatt-server\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://ivansantosgonzalez.dev/bluetooth-gatt-server</a>.</p>\n<p>Este artículo se divide en dos grandes bloques, un primer bloque para detallar la implementación de los <em>advertisements</em> y otro donde detallaremos la configuración del <em>GATT Server</em> y el servicio y características asociados.\nCabe destacar también que para el correcto funcionamiento de la aplicación de ejemplo desarrollada es necesario conceder permisos de Bluetooth a la misma. Para ello, se ha utilizado la librería PermissionX en la aplicación de ejemplo ya que el manejo de permisos no es el objetivo de este artículo.</p>\n<h2 id=\"advertisement\"><a href=\"#advertisement\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Advertisement</h2>\n<p>Para realizar el <strong><strong><strong>**</strong></strong></strong>advertisement<strong><strong><strong>**</strong></strong></strong> de paquetes a través de Bluetooth Low Energy hemos creado 4 funciones, <code>createAdvertisementParameters</code>, <code>createAdvertisementData</code> , <code>createAdvertisementCallback</code> y <code>startAdvertising</code> que se encargan de configurar los diferentes parámetros necesarios para iniciar el <strong><strong><strong>**</strong></strong></strong>advertisement<strong><strong><strong>**</strong></strong></strong> de paquetes.</p>\n<p>A continuación podemos observar la función <code>createAdvertisementParameters</code> que se encarga de configurar los diferentes parámetros relativos a cómo vamos a utilizar Bluetooth Low Energy para comunicarnos.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">private</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">fun</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">createAdvertisementParameters</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSetParameters</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t</span><span style=\"color: #81A1C1\">return</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSetParameters</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">Builder</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">setLegacyMode</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">true</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">setScannable</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">true</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">setConnectable</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">true</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">setInterval</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">AdvertisingSetParameters</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">INTERVAL_MIN</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">setTxPowerLevel</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">AdvertisingSetParameters</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">TX_POWER_MEDIUM</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">build</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<p>Hay más parámetros que podemos configurar pero los más importantes son los que observamos en el bloque código anterior.</p>\n<p>Dentro de los <em>advertisements</em> podemos incluir un total de 32 bytes de datos para el modo legacy <em>y</em> 255 si el modo utilizado es el extendido. Entre los datos que podemos incluir en los paquetes de <em>advertisement</em> destacan el nombre del dispositivo, un UUID de servicio en caso de tener configurado un servidor GATT y datos extra en el campo <strong><strong><strong>*</strong></strong></strong>service data<strong><strong><strong>*</strong></strong></strong>.</p>\n<p>En el siguiente bloque de código podemos observar la función  <code>createAdvertisementData</code> que se encarga de configurar estos parámetros.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">private</span><span style=\"color: #D8DEE9FF\"> funcreateAdvertisementData</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertiseData</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t</span><span style=\"color: #81A1C1\">return</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertiseData</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">Builder</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">setIncludeDeviceName</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">true</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">addServiceUuid</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">ParcelUuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">fromString</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">WEATHER_SERVICE_UUID</span><span style=\"color: #ECEFF4\">))</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">addServiceData</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">ParcelUuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">fromString</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">WEATHER_SERVICE_UUID</span><span style=\"color: #ECEFF4\">),</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">some data</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">.</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\ttoByteArray</span><span style=\"color: #ECEFF4\">())</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">build</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<p>Algo que debemos tener en cuenta cuando definimos estos parámetros es no sobrepasar el tamaño total del paquete de datos entre todos los campos ya que de lo contrario no podremos realizar el advertisement.</p>\n<p>Finalmente, podemos definir diferentes funciones de <em>callback</em> con las que reaccionaremos a los diferentes aspectos relacionados con los <em>advertisements</em>. Entre dichos eventos destacan el inicio del <em>advertisement</em>, el establecimiento de los datos del <em>advertisement</em>, el fin del <em>advertisement</em> y la respuesta al escaneo entre otros.</p>\n<p>En el siguiente bloque de código podemos observar la función <code>createAdvertisementCallback</code> y un ejemplo de creación de estos <em>callbacks.</em></p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">private</span><span style=\"color: #D8DEE9FF\"> funcreateAdvertisementCallback</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSetCallback</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">return</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">object:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSetCallback</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t</span><span style=\"color: #81A1C1\">override</span><span style=\"color: #D8DEE9FF\"> funonAdvertisingSetStarted</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #D8DEE9\">advertisingSet</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSet</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #D8DEE9\">txPower</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Int</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #D8DEE9\">status</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Int</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">i</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">onAdvertisingSetStarted(): txPower:$txPower , status: $status</span><span style=\"color: #ECEFF4\">&quot;</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">override</span><span style=\"color: #D8DEE9FF\"> funonAdvertisingDataSet</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">advertisingSet</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSet</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">status</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Int</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">i</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">onAdvertisingDataSet() :status:$status</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">override</span><span style=\"color: #D8DEE9FF\"> funonScanResponseDataSet</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">advertisingSet</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSet</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #D8DEE9\">status</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Int</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">i</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">onScanResponseDataSet(): status:$status</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">override</span><span style=\"color: #D8DEE9FF\"> funonAdvertisingSetStopped</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">advertisingSet</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">AdvertisingSet</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">i</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">onAdvertisingSetStopped():</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<p>Finalmente podemos ver la función <code>startAdvertising</code> que usa las funciones anteriores y comienza el <em>advertisement</em> de paquetes.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #D8DEE9FF\">funstartAdvertising</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    setupGattServer</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">context</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> advertisementParameters </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> createAdvertisementParameters</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> advertisementData </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> createAdvertisementData</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    bluetoothLeAdvertiser</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">startAdvertisingSet</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        advertisementParameters</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        advertisementData</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">null</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">null</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">null</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #B48EAD\">0</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #B48EAD\">0</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        advertisementCallback</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    isAdvertising </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">true</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">i</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">startAdvertising()</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<h2 id=\"gatt-server\"><a href=\"#gatt-server\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>GATT Server</h2>\n<p>Para crear nuestro servicio meteorológico necesitamos crear 1 <em>service</em> que contenga 2 <strong><strong><strong>***</strong></strong></strong>characteristics<strong><strong><strong>***</strong></strong></strong>, una para la temperatura y otra para la humedad. En nuestro código esto se realiza en la función <code>createGattService</code> que podemos ver a continuación.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">private</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">fun</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">createGattService</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothGattService</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> service </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothGattService</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">ParcelUuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">fromString</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">WEATHER_SERVICE_UUID</span><span style=\"color: #ECEFF4\">).</span><span style=\"color: #D8DEE9FF\">uuid</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">BluetoothGattService</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">SERVICE_TYPE_PRIMARY</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #ECEFF4\">)</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> temperatureCharacteristic </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">ParcelUuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">fromString</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">TEMPERATURE_CHARACTERISTIC_UUID</span><span style=\"color: #ECEFF4\">).</span><span style=\"color: #D8DEE9FF\">uuid</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">PROPERTY_READ</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">PERMISSION_READ</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    service</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">addCharacteristic</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">temperatureCharacteristic</span><span style=\"color: #ECEFF4\">)</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> humidityCharacteristic </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">ParcelUuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">fromString</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">HUMIDITY_CHARACTERISTIC_UUID</span><span style=\"color: #ECEFF4\">).</span><span style=\"color: #D8DEE9FF\">uuid</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">PROPERTY_READ</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">PERMISSION_READ</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    service</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">addCharacteristic</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">humidityCharacteristic</span><span style=\"color: #ECEFF4\">)</span></span>\n\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\treturns ervice</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<p>En esta función creamos nuestro servicio y características configurando sus UUID identificativos y las propiedades y permisos necesarios como definimos en el artículo anterior y podemos ver en el <a href=\"https://www.notion.so/Implementaci-n-de-GATT-Server-en-Android-230ae2f3e4784bbf85c65137912ec352?pvs=21\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">diagrama inicial</a> del artículo actual.</p>\n<p>Además de lo anterior debemos definir los <strong><strong>*</strong></strong>callbacks<strong><strong>*</strong></strong> necesarios para interactuar con los dispositivos que traten de leer nuestras <strong><strong><strong>***</strong></strong></strong>characteristics.<strong><strong><strong>***</strong></strong></strong> Esto es realizado sobrecargando la clase <code>BluetoothGattServerCallback</code> e implementando nuestros propios procesos para responder a los diferentes eventos. En el caso de nuestro ejemplo solo responderemos a los eventos de lectura, por lo tanto, solo implementaremos el callback <code>onCharacteristicReadRequest</code> como podemos observar en nuestra implementación que se muestra a continuación.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #D8DEE9FF\">inner classGattServerCallback </span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothGattServerCallback</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #81A1C1\">override</span><span style=\"color: #D8DEE9FF\"> funonCharacteristicReadRequest</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #D8DEE9\">device</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothDevice?</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #D8DEE9\">requestId</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Int</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #D8DEE9\">offset</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Int</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #D8DEE9\">characteristic</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">BluetoothGattCharacteristic?</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">super</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">onCharacteristicReadRequest</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">device</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> requestId</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> offset</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> characteristic</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">if</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">characteristic</span><span style=\"color: #81A1C1\">!!</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">uuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">toString</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">==</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">TEMPERATURE_CHARACTERISTIC_UUID</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">d</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">Reading temperature characteristic</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            gattServer</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">sendResponse</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                device</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                requestId</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #8FBCBB\">BluetoothGatt</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">GATT_SUCCESS</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                offset</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                temperatureValue</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">toByteArray</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t\t\t</span><span style=\"color: #81A1C1\">else</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">if</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">characteristic</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">uuid</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">toString</span><span style=\"color: #ECEFF4\">()</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">==</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">HUMIDITY_CHARACTERISTIC_UUID</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #8FBCBB\">Log</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">d</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #8FBCBB\">LOG_TAG</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #A3BE8C\">Reading humidity characteristic</span><span style=\"color: #ECEFF4\">&quot;</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            gattServer</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">sendResponse</span><span style=\"color: #ECEFF4\">(</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                device</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                requestId</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                </span><span style=\"color: #8FBCBB\">BluetoothGatt</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #8FBCBB\">GATT_SUCCESS</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                offset</span><span style=\"color: #ECEFF4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">                humidityValue</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">toByteArray</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">            </span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<p>Finalmente, utilizaremos la función <code>setupGattServer</code> para asignar todos los parámetros configurados mediante las funciones anteriores para incluirlo en nuestro servidor GATT. La función <code>setupGattServer</code> es invocada en la función <code>startAdvertising</code> para que todo el sistema funcione de manera conjunta.</p>\n<pre class=\"shiki\" style=\"background-color: #2e3440ff\"><code><span class=\"line\"><span style=\"color: #81A1C1\">private</span><span style=\"color: #D8DEE9FF\"> funsetupGattServer</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9\">context</span><span style=\"color: #81A1C1\">:</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">Context</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    gattServerCallback </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">GattServerCallback</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    gattServer </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> bluetoothManager</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">openGattServer</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">context</span><span style=\"color: #ECEFF4\">,</span><span style=\"color: #D8DEE9FF\">\tgattServerCallback</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> service </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> createGattService</span><span style=\"color: #ECEFF4\">()</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">\t\t</span><span style=\"color: #81A1C1\">val</span><span style=\"color: #D8DEE9FF\"> serviceExists </span><span style=\"color: #81A1C1\">=</span><span style=\"color: #D8DEE9FF\"> gattServer</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">getService</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">service</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">uuid</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">!=</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #81A1C1\">null</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #81A1C1\">if</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #81A1C1\">!</span><span style=\"color: #D8DEE9FF\">serviceExists</span><span style=\"color: #ECEFF4\">)</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #ECEFF4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">        gattServer</span><span style=\"color: #ECEFF4\">.</span><span style=\"color: #D8DEE9FF\">addService</span><span style=\"color: #ECEFF4\">(</span><span style=\"color: #D8DEE9FF\">service</span><span style=\"color: #ECEFF4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D8DEE9FF\">    </span><span style=\"color: #ECEFF4\">}</span></span>\n<span class=\"line\"><span style=\"color: #ECEFF4\">}</span></span></code></pre>\n<h2 id=\"conclusiones\"><a href=\"#conclusiones\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Conclusiones</h2>\n<p>Este artículo puede servir como continuación al anterior <a href=\"https://ivansantosgonzalez.dev/bluetooth-gatt-server\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://ivansantosgonzalez.dev/bluetooth-gatt-server</a> y trata de implementar un servicio meteorológico donde poner en práctica en una aplicación Android los diferentes conceptos relacionados con Bluetooth Low Energy y GATT vistos en el artículo anterior.</p>\n<p>Finalmente podemos observar una captura de la aplicación de prueba desarrollada, cuyo código está disponible en el siguiente repositorio de Github, <a href=\"https://github.com/IvanSantosGonz/BLEWeatherStation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/IvanSantosGonz/BLEWeatherStation</a>.</p>\n<p><img class=\"g-image g-image--lazy g-image--loading\" src=\"data:image/svg+xml,%3csvg fill='none' viewBox='0 0 345 750' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-fb4b56f4891b52714f802b1d2b1147f6'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-fb4b56f4891b52714f802b1d2b1147f6)' width='345' height='750' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAACLCAYAAADRRp%2bpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAPPUlEQVR42u1de1BU5xW/C2hqmlaTOiYYeS4sb2GXfbDyZgF5KA9ZFhAR8AmpiolGmyZtxFeqJqZ52aSJ0TZp2iSdJsZEEcRn1YiPdNpJZzptp%2b1Mm78602k7Ffbu5Ts959u9cME14rIC4cLMj/O9H797vvOd%2b%2b29u4Lg%2bcvLy1teXFx8edGiRb3lZeWuyspKV0VFpau0tNRVVFTkwjxXSUmJq7SklKctKl3kwrKuxYsXu8rKyjioXnl5hasCwWXFIMrlNDldEaa%2blixZ4qqqqroZS6p4HpWprHCPSW6T4nLdwfp2LimdwnV1S121tbWumpoaV21N7X/tdvtZHLddUP4tW7bs4PKGRlhYWASGVAMzGAyQkpICySnJkJSUBIlJiSw%2bIZ7FxcdDXFwcxHLEQkxMDOg4dKDTuRHNEQ3R0W5ERUdBVFQUaLVaiNRqWWRkJCBYBCEigoWHh4MCFGdh4WEQFhYGoRyhEBrqRgghJIRj3rx57OGHH2Zz585lwcHBHA899NAQYB7MC5lHZbFuCEdGRiYUF5dAZmbm83zyra0tdkpYWu8QZ9wXJGESGwLN0LBGo0jTaJgmIADTNCyApAcBI0WggFLg4cDAQIxTWqAH7nCgl/gAggJZ0LQAd95AuxrMGwzLY6Yx0phn3n%2bvy%2b6okMwmCxhNxkIhOzu3u7qmEloan5TCha2QrHmVJQgvQ5LwCiQiEhDzEcmaVyiN8hjGGcXnjxxseFqy5gAYNIdBLxzG9g%2b48wWvYF7Ax0PjjBR%2bCHHCS6APPMDHS%2bOOw3Rq3zMHlugprw98lYUI34G6ssfEsooSCJkX9qaQm5vz7xVNq6Eo%2bAgzCd0se0YnK3ygm%2bV8vYvlzzzJwxnTOplZ6MC8LlY27zQsCDgBacIJZkWkjQygjFuFTpQdLELYwLQB6zF8DKxCF0%2b7TV0KA/VL4ym4v5ttLrvOqqPP4SQ/wTF38jFWRZ1lFszPuofPBWwzuzz9dmB6Nyt44Lhkr2iAsPCQ80J%2bYZbTUdLmSg860Z8i/ArssR1s38YeaC04DU81XITXdv4GKrSdyOYHsCrrFHy/%2bQKUR3TglfsQLJojYBbuFB/gJDpBe89KCI6cA0HfECAkqAYn1cnzRtJGWsBHkIxl65JPAgCD3a3XoSntFOzdeAUqozrg0J7fQn1qFzy/6RpsrT0HB753hY/ZgGM2az5AIk5KJdYNoI2Z2yPk5Wc6q4s3iulBHZJJ%2bAjSpx9ljabTsCi0A6rjuqAsvBMWTPsYUrHj8vATsDr7NGTe%2bzFQWYtw9I5hxkHgACDka4th9sOzYNrsb8KD9%2bSTBvDJWUbYbprmKE7oCNQnnwLrtI%2bQhGvQmn8eih7sgJee%2bB0UzD4GS6I6Ie%2bBY1Ad3wWLQ07wOViEI2yB5qRUnNYGEdEPEQEZTkfpo2JG0AnJ0zlLwYKpGDZ4pNyhEcMUN3vivhBAfViF46DXHIIHAo3wrekG0Ae8jmkdI568koQUPqmjXEP1GDZhOBHDJj7%2bj3hc75kHlUeSWbqmWyq2tkFkdHCPkGvLcFaXbBTNwieSHiumCh8yI16lVAUMHgyP%2bw7q52Mk9BjiEw5K86Ut44A8AvK4jXzCH94Ed51fof04IRVZ2mgJXBYysqzObzc9Jb6x5p/SgaYv4EfNXzAE3G0caP4HSjfc4S/GBK80/Z0dWvsfaa3jaZgX/uBlYUGGxbm5dbt46UWQzj4LcO45YOf2czkU3tK85d%2bu3DjjzL5%2bdvVlkDavegbmhs5xE/DY2nbx9B6QOnaIcLxdZMeedqF0QQdhuzt8nNK2iTwup7ml6M7f5olvG8yj%2bnL4xM6JABzrjj52fh9IjzbvRg1AI2hFAja1tItn9oLUudsFl3/iZJ%2b954TLh51w5gURTj0nctnzlhM%2be68Puvdh/IcinH3RCScx/Nn7Ilx/1wkXX3fCqWdFlCJc/qkTzmKd0/tFOPcStvGsCzp3StCF7XfuQrnLNXLs9l/Zzl1EgpP9%2bjmQHkMCQiLQCC7wEIDqL9GV//x4H/vi817484U%2b%2bEtPL/zhzA346xWSiFN98OeLffC3azfgj%2bd7OTm/O9qH4T74fVcv/OkC1rvUB384TWURp93lr/3CidqAE3/GQ8Du8cEQAlbshtDIuQoCUC1IVc%2b9LLJPDzrhwqsi14Ken/bB1Z/3waWDfXDhNbzSmHflZ%2b4wqdWnh6iMEy696YTr77nlZUyT0y9iufMvO1EDXB4NGF94J2DtNm4DMBOOb3ey49tQtjvd6xvDx%2bT4diePc2wnAjzpnvxjTyviaC/keh1Udpe7PJfjiOM7etn5Z2kJ7IIwIsDKd4Ed4qfP4y6wBy3lPtwF9nF5e%2bwdYTm57ATAmT3Arr6Au8DKPRCmRQIyszKcTctWiasqn5QaF22BpsVbGAImKxoXPc5WV35PclQ2QGRURA/eDmc77fYqMWF%2bjKSLj4SYeC1DwGSFDucXn6STChfm06GLmwCHwyGaTGZJn2IAg97A9Hr0zycrUgzMZDRLRUVFdILVI%2bTk5Dirq6tFo9EoJScn01EYIzkZwY/5kpNZamqqtHDhQoiNjfVOABWcrFASEBMTM0WAkJ2T04cEuIyYqFYNcBOgWg3Izla3Bqh%2bCXg0QFS7DVD1NqjaJSA7QqrdBdwE5OaqnADVa8AUASr3BKcIUD0BKt4FVH0z5DkSuyRkqZOA/sLCQkhISPhcrRrA8vPzKe4cICBVhQTMnz/fqWoNwLCoag3AsEvVBGDcNaUBKvUEiQD6BExSMwG0C/Sq9l6APMEYna5brQTQSyD0HsPHZAR7VegHyAR8MkWASgmQbiZAhTZAq9UeVSsB8qFoN3042qtiP%2bAGbYOqJKCgoIAORETVEkAakJiY6FS1BiABolqNoKwBolr9gEEC1GwDkpKSFASoUAOGEqBGG0AEyDYgVa02YIqAqW3QNwKGPYJ%2bU1iZpqwzqQgYPim9Xj/iepNiCShJwBsLiI%2bPH5ByWAbFvZE27vcCo7UB9CUrpaWlUFZWBiUlJUAHDYTi4mIeJ0mdkSQNmSgaQPcCeFEkn11heSJEQEZGBjQ2NoLdbudy5cqVsHTpUqivr4eGhgaoq6vjcSSZ7sEnBAH0fEB0dPQ/haysLJ%2b3QZkEVCX%2b9Tqk6sOXA%2bUR5LwJsgTkM8Er9ISITwQoNcBqtYLFYhnRxCbIEuBHYkjA9VHdDcpbXVtbG1d7utIj2Qn8PCGfCcAlcH3Ut8O0plevXs3XOC0DipNWjAW8%2bSG%2bEHBjNK4wTTg9PZ2%2bmopLMohjAeoPxzwqDdDpdNfpVFjyvDDR7%2bsSIBswVhNXwi8E5OTmgS8EKNVuLNXe70sgJzcXfNUAuXMyfLfChDWC7m3QdwKUrMvurrzfkyQ/gORE2PtvuQ1GR1/zeQkoSSgvL%2bfur81m4y4vNV5TU8NdYPL%2bJsrkvSwB/xBA9wG1tbXc5XU4HFwuX76cIy0tbdzd31sSoNNd84sRlN1eMkyylJ2iibwEPBrguw2QdwC6yiaTiYeVhm%2biTd4rAdk5uaNeAuvXr4cVK1bwK/8Vc4WvjWobpPKyK0zrPjY2dkD9xwJ%2b8AOujdoPIALQnYa8vDwuc3Jy7jrkfnzZYYb5AVdHvQRI0q3wggUL%2bL0AybEA9UVf/%2bsrAZ5HZMgG5KjSFSYCIiIirgpZ2TmjdoXH2ar7rAEDBDgcvhPgXTMG7YM/4M/t9JYaQC8S%2be%2bTIbdKkpEi/8BkMivgjpvNyvhwDC3vT4fKCwHZHgKMfiNAHmRVVTVuj/WoYbXYRw1Hbe1SHrfbHTxeU1N3E5Tl6%2bsb%2bOEHrXl/H4oOIcBfS0BJQHW1A5qaVqCfsBbWrdsAjzyyDu8PmmDNmhZoa3sU49%2bG5uaVHCtWrOJ5hFWr1vCyLS2P8PiYEODPJeBuR881oL19B7z//i/h7bffgYMHD8Fbb70Nb7xxEA4c%2bBH8%2bMevw%2bOPb4VDhw7DO%2b/8gqf94Ad74N133%2bNl33zzMBK3nm97/rqhGkMN0MOSJXZ%2b5Z944klobGyGTZse5xOmq09Xl8KkIZs2bYaNGx%2bD7373Kdiy5TuwdesTsHnzFh5euXI1P/66axrgqx8wkiVA65zWPEmlLSApr3VKl9e7nKeUZAOysrLvJgG5fidAJoEsOHmJXwaz2XLbMv78TPEmAkZ7L/Bljol7H08apR/gm8c3rhqgdIbGy%2bMbCQGRkZEKG5DqXw24S1%2bG6F8CtNoBApz%2btgFfhTdGUAOu3JVd4KtCQAQRgF6Ws9rhEFNV%2bM4Q1wB0Mm44HA6XGgnAXQAJyMzsVTcBGRlTBKiagPT09CkNUCsB4eHh6jaCUwQQAZlTBEwRoFoCwlRPAP3ChJq3QSRAxY5QcfGgDahWIQH0NFuk5zxAdRpgMBg4AVqttke1RpAIiI6O5gSo70AENYDeZ4qKiupR5YmQwUOAVs0E0Jtu3AZMEaDmJeDZBW7QT9OrlgClBngeSJq0vzXmebJ1gIBIIgBdYa4BZrNZoo%2bhMZMKwGQFzpGZTCZuA9ATRAJQA%2bx2uysuLk7CfZGcA4YAf4HaHC38PB4WExMjFbpfnORfrn6jpLTUpdFoJEEQAMFUAImeO4pPSLhMX6Lyv7q6OjZjxgzmIcAvQEK5pLdG9u7dC%2b3t7bBjx447ws6dOyE4OHhIe/7A9OnTJXrLBZfDJbIB/6JXXwsKCjg72JFf2cbO2L1I7gwf4c/xyG3Rcm9tbaVHeC4KqApXN2zYAC0tLf2Y2R8YGCj5E56lJQkoB8IyKK7IHwJPmQA/jiUoKIja7Ldara5169aRBhwR8N%2bTzc3NsH///l40Cv333XcfmzVrFps5c%2bYghsfvBFR3NPC1Xy%2bYdf/9JPvXrl3bR0sTjeIasgGzkIS/LmtooAclWGxsrIToR0vpDZIC/bcDb%2bfmtqThZWTcKn0AWFcenxdItwHvm7b6qqoqes/pLPo/AQL9WSwW7ezZszvmzJnjDAkJAW8IDQ2lM7RBhIfTkdKtERHhBoblshFyXNmOApSPe/NAOZJyGjotA1KrwJ1uo1jnPzqd7jW82F/nk0%2bIj3ezQOGEhChErkGvtxlTU21Go9GGhsKGTtIA0iwWmzUtzYbryIYsDgBJHAIqS/XR%2bbChl8nbsWAaXgEbDsSGg%2bCgsAz01Hg5Kj8/KcmWiEDPzYYu7ACSEZRGoPIEOf5lwLr52HbWwsLCYHm%2bOAfN/wGu1LAJ8EUqXwAAAABJRU5ErkJggg==' /%3e%3c/svg%3e\" width=\"345\" alt=\"weather-station-app.png\" data-srcset=\"/assets/static/weather-station-app.c76d370.699c54e5dce979e8978c0d58983f31f2.png 345w\" data-sizes=\"(max-width: 345px) 100vw, 345px\" data-src=\"/assets/static/weather-station-app.c76d370.699c54e5dce979e8978c0d58983f31f2.png\"><noscript><img class=\"g-image g-image--lazy g-image--loaded\" src=\"/assets/static/weather-station-app.c76d370.699c54e5dce979e8978c0d58983f31f2.png\" width=\"345\" alt=\"weather-station-app.png\"></noscript></p>\n","tags":[{"title":"Bluetooth","path":"/tag/Bluetooth/"},{"title":"GATT","path":"/tag/GATT/"},{"title":"Android","path":"/tag/Android/"},{"title":"BLE","path":"/tag/BLE/"},{"title":"Service","path":"/tag/Service/"},{"title":"Characteristic","path":"/tag/Characteristic/"}]}},"context":{}}